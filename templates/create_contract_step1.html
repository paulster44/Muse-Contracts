{% extends "base.html" %}
{% block title %}Create Contract - Step {{ step_num }}{% endblock %}

{% block content %}
  <h2>Create Contract - Step {{ step_num }}: Basic Engagement Info</h2>
  <hr>
  {# Use method="POST", no action needed as Flask handles it #}
  <form method="POST" id="step1-form">
    {{ form.hidden_tag() }} {# IMPORTANT: Include CSRF token #}

    {# Display General Form Errors (Optional) #}
    {% if form.errors and not form.validate() %} {# Check if there are errors after validation attempt #}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Please correct the errors below:</strong>
          <ul>
            {% for field, error_list in form.errors.items() %}
              {% for error in error_list %}
                <li>{{ form[field].label.text }}: {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}


    <div class="row g-3 mb-4 form-step">
      {# --- Field Rendering using WTForms --- #}
      {# Engagement Date, Start Time, End Time #}
      <div class="col-md-4">
        {{ form.engagement_date.label(class="form-label required") }}
        {# Add type="date" for browser picker #}
        {{ form.engagement_date(class="form-control form-control-sm" + (" is-invalid" if form.engagement_date.errors else ""), type="date") }}
        {% for error in form.engagement_date.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
      <div class="col-md-4">
        {{ form.start_time.label(class="form-label required") }}
        {# Add type="time" for browser picker #}
        {{ form.start_time(class="form-control form-control-sm" + (" is-invalid" if form.start_time.errors else ""), type="time") }}
         {% for error in form.start_time.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
       <div class="col-md-4">
        {{ form.end_time.label(class="form-label required") }}
        {{ form.end_time(class="form-control form-control-sm" + (" is-invalid" if form.end_time.errors else ""), type="time") }}
         {% for error in form.end_time.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>

      {# Leader Info #}
      <div class="col-md-6">
        {{ form.leader_name.label(class="form-label required") }}
        {{ form.leader_name(class="form-control form-control-sm" + (" is-invalid" if form.leader_name.errors else "")) }}
         {% for error in form.leader_name.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
       <div class="col-md-6">
        {{ form.leader_card_no.label(class="form-label") }}
        {{ form.leader_card_no(class="form-control form-control-sm" + (" is-invalid" if form.leader_card_no.errors else "")) }}
         {% for error in form.leader_card_no.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
      <div class="col-12">
        {{ form.leader_address.label(class="form-label required") }}
        {{ form.leader_address(class="form-control form-control-sm" + (" is-invalid" if form.leader_address.errors else ""), placeholder="Street, City, State, Zip") }}
         {% for error in form.leader_address.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
       <div class="col-md-6">
        {{ form.leader_phone.label(class="form-label required") }}
        {{ form.leader_phone(class="form-control form-control-sm" + (" is-invalid" if form.leader_phone.errors else ""), type="tel") }}
         {% for error in form.leader_phone.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
       <div class="col-md-6">
           {{ form.leader_ssn_ein.label(class="form-label") }} <span class="text-muted">(Optional)</span> {# Updated Label #}
           {{ form.leader_ssn_ein(class="form-control form-control-sm" + (" is-invalid" if form.leader_ssn_ein.errors else ""), placeholder="Leave blank for manual entry") }} {# Added Placeholder #}
            {% for error in form.leader_ssn_ein.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
            <div class="form-text pii-warning">Sensitive Data - Recommended to leave blank.</div>
      </div>

      {# Engagement Info #}
       <div class="col-md-6">
        {{ form.band_name.label(class="form-label") }}
        {{ form.band_name(class="form-control form-control-sm" + (" is-invalid" if form.band_name.errors else "")) }}
         {% for error in form.band_name.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
       <div class="col-md-6">
        {{ form.venue_name.label(class="form-label required") }}
        {{ form.venue_name(class="form-control form-control-sm" + (" is-invalid" if form.venue_name.errors else "")) }}
         {% for error in form.venue_name.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
      <div class="col-md-6">
         {{ form.location_borough.label(class="form-label required") }}
         {{ form.location_borough(class="form-select form-select-sm" + (" is-invalid" if form.location_borough.errors else "")) }}
         {% for error in form.location_borough.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
       <div class="col-md-6">
        {{ form.engagement_type.label(class="form-label required") }}
        {# Pass description to render_kw in form definition for placeholder #}
        {{ form.engagement_type(class="form-control form-control-sm" + (" is-invalid" if form.engagement_type.errors else "")) }}
         {% for error in form.engagement_type.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
       <div class="col-md-6">
        {{ form.pre_heat_hours.label(class="form-label") }}
        {# Use type="number" for better browser handling #}
        {{ form.pre_heat_hours(class="form-control form-control-sm" + (" is-invalid" if form.pre_heat_hours.errors else ""), type="number", step="0.1", min="0") }}
         {% for error in form.pre_heat_hours.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
      </div>
    </div>

    {# --- Render Submit Buttons from Form Object --- #}
    <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">Cancel & Exit</a>
        <div>
            {# Render submit fields defined in the Form class #}
            {{ form.save_draft(class="btn btn-secondary me-2") }}
            {{ form.submit_next(class="btn btn-primary") }}
        </div>
    </div>

  </form> {# End of form #}
{% endblock %}
