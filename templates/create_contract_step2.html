```html
{% extends "base.html" %}
{% block title %}Create Contract - Step {{ step_num }}{% endblock %}

{% block content %}
 <h2>Create Contract - Step {{ step_num }}: Musicians & Clauses</h2>
 <hr>
 {# Use method="POST" - action determined by Flask route #}
 <form method="POST" id="step2-form">
    {{ form.hidden_tag() }} {# IMPORTANT: Include CSRF token #}

    {# Display General Form Errors (Optional) #}
    {% if form.errors and not form.validate() %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <strong>Please correct the errors below:</strong>
          <ul>
            {% for field, error_list in form.errors.items() %}
              {# Only show errors for fields actually in THIS form step #}
              {% if field in ['num_musicians', 'actual_hours_engagement', 'has_rehearsal', 'actual_hours_rehearsal', 'is_recorded', 'leader_is_incorporated'] %}
                  {% for error in error_list %}
                    <li>{{ form[field].label.text }}: {{ error }}</li>
                  {% endfor %}
              {% endif %}
            {% endfor %}
            {# Display side musician errors separately if needed #}
          </ul>
           <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endif %}


    {# --- Render Core Step 2 Fields using WTForms --- #}
    <div class="row g-3 mb-4 form-step">
        <div class="col-md-4">
           {{ form.num_musicians.label(class="form-label required") }}
           {{ form.num_musicians(class="form-control form-control-sm" + (" is-invalid" if form.num_musicians.errors else ""), **{'id': 'num_musicians'}) }} {# Ensure JS target ID is set #}
           {% for error in form.num_musicians.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
           <div class="form-text">Adjusting this will add/remove side musician fields below.</div>
        </div>
         <div class="col-md-4">
           {{ form.actual_hours_engagement.label(class="form-label required") }}
           {{ form.actual_hours_engagement(class="form-control form-control-sm" + (" is-invalid" if form.actual_hours_engagement.errors else ""), type="number", step="0.1", min="0") }}
           {% for error in form.actual_hours_engagement.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
           <div class="form-text">May differ based on scale minimums.</div>
         </div>
    </div>

   <div class="row g-3 mb-4 form-step">
       <div class="col-md-6 d-flex align-items-center">
            <div class="form-check">
             {# Render BooleanField as checkbox #}
             {{ form.has_rehearsal(class="form-check-input" + (" is-invalid" if form.has_rehearsal.errors else ""), **{'id': 'has_rehearsal'}) }}
             {{ form.has_rehearsal.label(class="form-check-label") }}
             {% for error in form.has_rehearsal.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
           </div>
       </div>
        <div class="col-md-6" id="rehearsal-hours-section" style="display: {{ 'block' if form.has_rehearsal.data else 'none' }};"> {# Initial display based on form data #}
            {{ form.actual_hours_rehearsal.label(class="form-label") }}
            {{ form.actual_hours_rehearsal(class="form-control form-control-sm" + (" is-invalid" if form.actual_hours_rehearsal.errors else ""), type="number", step="0.1", min="0") }}
            {% for error in form.actual_hours_rehearsal.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
            <div class="form-text">Required if rehearsal box is checked.</div>
       </div>
   </div>

    {# --- Side Musician Entry Section (Still uses JS + Template) --- #}
    <hr>
    <h4 class="mb-3">Side Musician Details</h4>
    <p class="text-muted" id="side-musician-helper-text">Add details for each musician other than the leader.</p>
    <div id="musicians-list" class="mb-3">
        {# Side musician forms will be inserted here by JavaScript #}
    </div>

    {# --- Clauses Section (Render using WTForms Checkboxes) --- #}
    <hr>
    <h4 class="mb-3">Clauses & Notes</h4>
     <div class="row g-3 mb-4 form-step">
          <div class="col-md-6">
             <div class="form-check">
              {{ form.is_recorded(class="form-check-input" + (" is-invalid" if form.is_recorded.errors else ""), **{'id': 'is_recorded'}) }}
              {{ form.is_recorded.label(class="form-check-label") }}
              {% for error in form.is_recorded.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
               <div id="recording-warning" class="form-text text-danger fw-bold" style="display: {{ 'block' if form.is_recorded.data else 'none' }};">
                   Clause 3 prohibits recording without specific written Union agreement. Consult Local 802.
               </div>
            </div>
        </div>
         <div class="col-md-6">
             <div class="form-check">
              {{ form.leader_is_incorporated(class="form-check-input" + (" is-invalid" if form.leader_is_incorporated.errors else ""), **{'id': 'leader_is_incorporated'}) }}
              {{ form.leader_is_incorporated.label(class="form-check-label") }}
              {% for error in form.leader_is_incorporated.errors %} <div class="invalid-feedback d-block">{{ error }}</div> {% endfor %}
               <div id="incorporation-note" class="form-text" style="display: {{ 'block' if form.leader_is_incorporated.data else 'none' }};">
                   A valid Certificate of Incorporation may be required. Contributions for the leader possible only if incorporated.
               </div>
            </div>
        </div>
     </div>

     {# --- Placeholder Note --- #}
     <div class="alert alert-warning" role="alert">
         Note: Payment calculations use Local 802 Classical Concert scale rates. Actual scale, overtime, doubling, and cartage rules are needed for full accuracy. Totals update on save.
     </div>

    {# --- Navigation Buttons (Render from WTForms Object) --- #}
    <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('create_contract_step', contract_id=contract.id, step_num=1) }}" class="btn btn-outline-secondary">Â« Back to Step 1</a>
         <div>
            {{ form.save_draft(class="btn btn-secondary me-2") }}
            {{ form.submit_view(class="btn btn-primary") }} {# Use submit_view name #}
        </div>
    </div>

 </form> {# End of Step 2 Form #}

{# --- Hidden Template for a single side musician's form (Remains the same) --- #}
<template id="musician-template">
    <div class="card mb-3 musician-card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Side Musician #<span class="musician-number"></span></h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="musician-__INDEX__-name" class="form-label required">Full Name</label>
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-name" name="musician-__INDEX__-name" required>
                </div>
                <div class="col-md-6">
                    <label for="musician-__INDEX__-instrument" class="form-label">Instrument(s)</label>
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-instrument" name="musician-__INDEX__-instrument">
                </div>
                <div class="col-md-6">
                    <label for="musician-__INDEX__-tax_id" class="form-label">Tax ID / ID # <span class="text-muted">(Optional)</span></label> {# Changed Label, Removed required #}
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-tax_id" name="musician-__INDEX__-tax_id" placeholder="Leave blank for manual entry"> {# Changed ID/Name, Removed required/pattern #}
                    <div class="form-text pii-warning">Sensitive Data - Recommended to leave blank.</div>
                </div>
                <div class="col-md-6">
                    <label for="musician-__INDEX__-card_no" class="form-label">AFM Card #</label>
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-card_no" name="musician-__INDEX__-card_no">
                </div>
                <div class="col-md-6">
                    <div class="form-check mt-2 pt-3">
                         <input class="form-check-input" type="checkbox" id="musician-__INDEX__-is_doubling" name="musician-__INDEX__-is_doubling">
                         <label class="form-check-label" for="musician-__INDEX__-is_doubling">Doubling?</label>
                         <small class="text-muted d-block">(Plays multiple instruments per scale)</small>
                    </div>
                </div>
                 <div class="col-md-6">
                    <div class="form-check mt-2 pt-3">
                         <input class="form-check-input" type="checkbox" id="musician-__INDEX__-has_cartage" name="musician-__INDEX__-has_cartage">
                         <label class="form-check-label" for="musician-__INDEX__-has_cartage">Cartage?</label>
                         <small class="text-muted d-block">(Transports large instruments per scale)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

{% endblock %} {# End of content block #}


{% block scripts %}
{# --- JavaScript for dynamic musician forms & conditional visibility (Remains the same) --- #}
<script>
 document.addEventListener('DOMContentLoaded', function() {
    const numMusiciansInput = document.getElementById('num_musicians'); // Target WTForms field ID
    const musiciansListDiv = document.getElementById('musicians-list');
    const musicianTemplate = document.getElementById('musician-template');
    const musicianHelperText = document.getElementById('side-musician-helper-text');
    let existingMusicians = {{ musicians_json | tojson | safe }};
    console.log("Existing Musicians Data on Load:", existingMusicians);

    const rehearsalCheck = document.getElementById('has_rehearsal'); // Target WTForms field ID
    const rehearsalHoursSection = document.getElementById('rehearsal-hours-section');
    const recordingCheck = document.getElementById('is_recorded'); // Target WTForms field ID
    const recordingWarning = document.getElementById('recording-warning');
    const incorporatedCheck = document.getElementById('leader_is_incorporated'); // Target WTForms field ID
    const incorporationNote = document.getElementById('incorporation-note');

    function renderMusicianForms(totalMusicians) {
        const numSideMusicians = Math.max(0, totalMusicians - 1);
        musiciansListDiv.innerHTML = ''; // Clear forms

        if (numSideMusicians === 0) { musicianHelperText.textContent = 'No side musicians needed.'; }
        else {
             musicianHelperText.textContent = `Details for the ${numSideMusicians} side musician(s):`;
             for (let i = 0; i < numSideMusicians; i++) {
                 const templateContent = musicianTemplate.content.cloneNode(true);
                 const musicianCard = templateContent.firstElementChild;
                 musicianCard.querySelector('.musician-number').textContent = i + 1;
                 const elementsToUpdate = musicianCard.querySelectorAll('[id*="__INDEX__"], [name*="__INDEX__"], [for*="__INDEX__"]');
                 elementsToUpdate.forEach(el => {
                     if (el.id) el.id = el.id.replaceAll('__INDEX__', i);
                     if (el.name) el.name = el.name.replaceAll('__INDEX__', i);
                     if (el.htmlFor) el.htmlFor = el.htmlFor.replaceAll('__INDEX__', i);
                 });
                 // Populate fields if data exists for this index
                 if (existingMusicians && existingMusicians[i]) {
                     const data = existingMusicians[i];
                     const nameInput = musicianCard.querySelector(`input[name="musician-${i}-name"]`);
                     const instrumentInput = musicianCard.querySelector(`input[name="musician-${i}-instrument"]`);
                     const taxIdInput = musicianCard.querySelector(`input[name="musician-${i}-tax_id"]`);
                     const cardNoInput = musicianCard.querySelector(`input[name="musician-${i}-card_no"]`);
                     const doublingCheck = musicianCard.querySelector(`input[name="musician-${i}-is_doubling"]`);
                     const cartageCheck = musicianCard.querySelector(`input[name="musician-${i}-has_cartage"]`);
                     if (nameInput) nameInput.value = data.name || '';
                     if (instrumentInput) instrumentInput.value = data.instrument || '';
                     if (taxIdInput) taxIdInput.value = data.tax_id || '';
                     if (cardNoInput) cardNoInput.value = data.card_no || '';
                     if (doublingCheck) doublingCheck.checked = data.is_doubling || false;
                     if (cartageCheck) cartageCheck.checked = data.has_cartage || false;
                 }
                 musiciansListDiv.appendChild(templateContent);
             }
        }
    }

    function toggleVisibility(checkbox, element) { if (checkbox && element) element.style.display = checkbox.checked ? 'block' : 'none'; }

    // Event Listeners & Initial Calls
    if (numMusiciansInput) {
        numMusiciansInput.addEventListener('input', function() {
            const count = parseInt(this.value, 10) || 0;
            existingMusicians = []; // Reset existing data source on manual change
            renderMusicianForms(count);
        });
        renderMusicianForms(parseInt(numMusiciansInput.value, 10) || 0); // Initial render
    }
    if (rehearsalCheck) { rehearsalCheck.addEventListener('change', () => toggleVisibility(rehearsalCheck, rehearsalHoursSection)); toggleVisibility(rehearsalCheck, rehearsalHoursSection); }
    if (recordingCheck) { recordingCheck.addEventListener('change', () => toggleVisibility(recordingCheck, recordingWarning)); toggleVisibility(recordingCheck, recordingWarning); }
    if (incorporatedCheck) { incorporatedCheck.addEventListener('change', () => toggleVisibility(incorporatedCheck, incorporationNote)); toggleVisibility(incorporatedCheck, incorporationNote); }

 });
</script>
{% endblock %} {# End of scripts block #}
