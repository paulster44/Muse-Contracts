{% extends "base.html" %}
{% block title %}Create Contract - Step {{ step_num }}{% endblock %}

{% block content %}
 <h2>Create Contract - Step {{ step_num }}: Musicians & Clauses</h2>
 <hr>
 {# Use non-validated form tag; validation handled in Flask or via JS if needed #}
 <form method="POST" action="{{ url_for('create_contract_step', contract_id=contract.id, step_num=step_num) }}" id="step2-form">

    {# --- Core Step 2 Fields --- #}
    <div class="row g-3 mb-4 form-step">
        <div class="col-md-4">
           <label for="num_musicians" class="form-label required">Total Number of Musicians (incl. Leader)</label>
           <input type="number" min="1" step="1" class="form-control" id="num_musicians" name="num_musicians" value="{{ contract.num_musicians or 1 }}" required>
           <div class="form-text">Adjusting this will add/remove side musician fields below.</div>
        </div>
         <div class="col-md-4">
           <label for="actual_hours_engagement" class="form-label required">Actual Paid Hours of Engagement</label>
           <input type="number" step="0.1" min="0" class="form-control" id="actual_hours_engagement" name="actual_hours_engagement" value="{{ contract.actual_hours_engagement if contract.actual_hours_engagement is not none else '' }}" required>
           <div class="form-text">May differ based on scale minimums.</div>
         </div>
    </div>

   <div class="row g-3 mb-4 form-step">
       <div class="col-md-6 d-flex align-items-center">
            <div class="form-check">
             <input class="form-check-input" type="checkbox" id="has_rehearsal" name="has_rehearsal" {% if contract.has_rehearsal %}checked{% endif %}>
             <label class="form-check-label" for="has_rehearsal">
               Is there a Rehearsal?
             </label>
           </div>
       </div>
        <div class="col-md-6" id="rehearsal-hours-section" style="display: {% if contract.has_rehearsal %}block{% else %}none{% endif %};">
            <label for="actual_hours_rehearsal" class="form-label">Actual Paid Hours of Rehearsal</label>
            <input type="number" step="0.1" min="0" class="form-control" id="actual_hours_rehearsal" name="actual_hours_rehearsal" value="{{ contract.actual_hours_rehearsal if contract.actual_hours_rehearsal is not none else '' }}">
            <div class="form-text">Required if rehearsal box is checked.</div>
       </div>
   </div>

    {# --- Side Musician Entry Section --- #}
    <hr>
    <h4 class="mb-3">Side Musician Details</h4>
    <p class="text-muted" id="side-musician-helper-text">Add details for each musician other than the leader.</p>
    {# Container where JS will inject the musician forms #}
    <div id="musicians-list" class="mb-3">
        {# Forms are generated by JS based on num_musicians #}
    </div>

    {# --- Clauses Section --- #}
    <hr>
    <h4 class="mb-3">Clauses & Notes</h4>
     <div class="row g-3 mb-4 form-step">
          <div class="col-md-6">
             <div class="form-check">
              <input class="form-check-input" type="checkbox" id="is_recorded" name="is_recorded" {% if contract.is_recorded %}checked{% endif %}>
              <label class="form-check-label" for="is_recorded">
                Will performance be Recorded/Reproduced/Transmitted?
              </label>
               <div id="recording-warning" class="form-text text-danger fw-bold" style="display: {% if contract.is_recorded %}block{% else %}none{% endif %};">
                   Clause 3 prohibits recording without specific written Union agreement. Consult Local 802.
               </div>
            </div>
        </div>
         <div class="col-md-6">
             <div class="form-check">
              <input class="form-check-input" type="checkbox" id="leader_is_incorporated" name="leader_is_incorporated" {% if contract.leader_is_incorporated %}checked{% endif %}>
              <label class="form-check-label" for="leader_is_incorporated">
                Is the Leader/Employer signing as an incorporated entity?
              </label>
               <div id="incorporation-note" class="form-text" style="display: {% if contract.leader_is_incorporated %}block{% else %}none{% endif %};">
                   A valid Certificate of Incorporation may be required. Contributions for the leader possible only if incorporated.
               </div>
            </div>
        </div>
     </div>

     {# --- Placeholder Note --- #}
     <div class="alert alert-warning" role="alert">
         Note: Payment calculations use Local 802 Classical Concert scale rates. Actual scale, overtime, etc., needed for full accuracy. Totals update on save.
     </div>

    {# --- Navigation Buttons --- #}
    <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('create_contract_step', contract_id=contract.id, step_num=1) }}" class="btn btn-outline-secondary">« Back to Step 1</a>
         <div> {# Group buttons on the right #}
            <button type="submit" name="save_draft" value="1" class="btn btn-secondary me-2">Save Draft & Exit</button> {# Saves current step and returns to dashboard #}
            <button type="submit" class="btn btn-primary">Save Step 2 & View »</button> {# Saves current step and goes to view page #}
        </div>
    </div>

 </form> {# End of Step 2 Form #}

{# --- Hidden Template for a single side musician's form --- #}
{# This is cloned by JavaScript #}
<template id="musician-template">
    <div class="card mb-3 musician-card shadow-sm"> {# Added shadow #}
        <div class="card-header bg-light"> {# Lighter header #}
            <h5 class="mb-0">Side Musician #<span class="musician-number"></span></h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="musician-__INDEX__-name" class="form-label required">Full Name</label>
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-name" name="musician-__INDEX__-name" required>
                </div>
                <div class="col-md-6">
                    <label for="musician-__INDEX__-instrument" class="form-label">Instrument(s)</label>
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-instrument" name="musician-__INDEX__-instrument">
                </div>
                <div class="col-md-6">
                    <label for="musician-__INDEX__-tax_id" class="form-label required">Tax ID / ID #</label> {# Changed Label #}
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-tax_id" name="musician-__INDEX__-tax_id" required placeholder="e.g., SSN, SIN, etc."> {# Changed ID/Name, Removed Pattern #}
                    <div class="form-text pii-warning">Sensitive Data - Required for benefits/payment.</div>
                </div>
                <div class="col-md-6">
                    <label for="musician-__INDEX__-card_no" class="form-label">AFM Card #</label>
                    <input type="text" class="form-control form-control-sm" id="musician-__INDEX__-card_no" name="musician-__INDEX__-card_no">
                </div>
                <div class="col-md-6">
                    <div class="form-check mt-2 pt-3">
                         <input class="form-check-input" type="checkbox" id="musician-__INDEX__-is_doubling" name="musician-__INDEX__-is_doubling">
                         <label class="form-check-label" for="musician-__INDEX__-is_doubling">
                           Doubling?
                         </label>
                         <small class="text-muted d-block">(Plays multiple instruments per scale)</small>
                    </div>
                </div>
                 <div class="col-md-6">
                    <div class="form-check mt-2 pt-3">
                         <input class="form-check-input" type="checkbox" id="musician-__INDEX__-has_cartage" name="musician-__INDEX__-has_cartage">
                         <label class="form-check-label" for="musician-__INDEX__-has_cartage">
                           Cartage?
                         </label>
                         <small class="text-muted d-block">(Transports large instruments per scale)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template> {# End of hidden template #}

{% endblock %} {# End of content block #}


{% block scripts %} {# Start of scripts block #}
{# --- JavaScript for dynamic musician forms & conditional visibility --- #}
<script>
 document.addEventListener('DOMContentLoaded', function() {
    // --- Elements ---
    const numMusiciansInput = document.getElementById('num_musicians');
    const musiciansListDiv = document.getElementById('musicians-list');
    const musicianTemplate = document.getElementById('musician-template');
    const musicianHelperText = document.getElementById('side-musician-helper-text');

    // --- Get Existing Musician Data (passed from Flask as musicians_json) ---
    let existingMusicians = {{ musicians_json | tojson | safe }};
    console.log("Existing Musicians Data on Load:", existingMusicians); // Debugging line

    // --- Elements for Conditional Visibility ---
    const rehearsalCheck = document.getElementById('has_rehearsal');
    const rehearsalHoursSection = document.getElementById('rehearsal-hours-section');
    const recordingCheck = document.getElementById('is_recorded');
    const recordingWarning = document.getElementById('recording-warning');
    const incorporatedCheck = document.getElementById('leader_is_incorporated');
    const incorporationNote = document.getElementById('incorporation-note');

    // --- Function to Render Musician Forms ---
    function renderMusicianForms(totalMusicians) {
        const numSideMusicians = Math.max(0, totalMusicians - 1); // Leader isn't in this list
        musiciansListDiv.innerHTML = ''; // Clear existing forms first

        if (numSideMusicians === 0) {
             musicianHelperText.textContent = 'No side musicians needed based on the number entered.';
        } else {
             musicianHelperText.textContent = `Please provide details for the ${numSideMusicians} side musician(s):`;
             for (let i = 0; i < numSideMusicians; i++) {
                 const templateContent = musicianTemplate.content.cloneNode(true);
                 const musicianCard = templateContent.firstElementChild; // Get the card div directly
                 musicianCard.querySelector('.musician-number').textContent = i + 1;

                 const elementsToUpdate = musicianCard.querySelectorAll('[id*="__INDEX__"], [name*="__INDEX__"], [for*="__INDEX__"]');
                 elementsToUpdate.forEach(el => {
                     if (el.id) el.id = el.id.replaceAll('__INDEX__', i);
                     if (el.name) el.name = el.name.replaceAll('__INDEX__', i);
                     if (el.htmlFor) el.htmlFor = el.htmlFor.replaceAll('__INDEX__', i);
                 });

                 // Populate fields with existing data if available
                 if (existingMusicians && existingMusicians[i]) {
                     const data = existingMusicians[i];
                     const nameInput = musicianCard.querySelector(`input[name="musician-${i}-name"]`);
                     const instrumentInput = musicianCard.querySelector(`input[name="musician-${i}-instrument"]`);
                     const taxIdInput = musicianCard.querySelector(`input[name="musician-${i}-tax_id"]`); // Use tax_id
                     const cardNoInput = musicianCard.querySelector(`input[name="musician-${i}-card_no"]`);
                     const doublingCheck = musicianCard.querySelector(`input[name="musician-${i}-is_doubling"]`);
                     const cartageCheck = musicianCard.querySelector(`input[name="musician-${i}-has_cartage"]`);

                     if (nameInput) nameInput.value = data.name || '';
                     if (instrumentInput) instrumentInput.value = data.instrument || '';
                     if (taxIdInput) taxIdInput.value = data.tax_id || ''; // Populate tax_id
                     if (cardNoInput) cardNoInput.value = data.card_no || '';
                     if (doublingCheck) doublingCheck.checked = data.is_doubling || false;
                     if (cartageCheck) cartageCheck.checked = data.has_cartage || false;
                 }
                 musiciansListDiv.appendChild(templateContent);
             }
        }
    }

    // --- Function for Conditional Visibility ---
    function toggleVisibility(checkbox, element) { if (checkbox && element) element.style.display = checkbox.checked ? 'block' : 'none'; }

    // --- Event Listeners & Initial Calls ---
    if (numMusiciansInput) {
        numMusiciansInput.addEventListener('input', function() {
            const count = parseInt(this.value, 10) || 0;
            existingMusicians = []; // Reset existing data when count is manually changed
            renderMusicianForms(count);
        });
        renderMusicianForms(parseInt(numMusiciansInput.value, 10) || 0); // Initial render
    }
    if (rehearsalCheck) { rehearsalCheck.addEventListener('change', () => toggleVisibility(rehearsalCheck, rehearsalHoursSection)); toggleVisibility(rehearsalCheck, rehearsalHoursSection); }
    if (recordingCheck) { recordingCheck.addEventListener('change', () => toggleVisibility(recordingCheck, recordingWarning)); toggleVisibility(recordingCheck, recordingWarning); }
    if (incorporatedCheck) { incorporatedCheck.addEventListener('change', () => toggleVisibility(incorporatedCheck, incorporationNote)); toggleVisibility(incorporatedCheck, incorporationNote); }

 });
</script>
{% endblock %} {# End of scripts block #}
