{% extends "base.html" %} {# Make sure it extends your base template #}

{% block title %}View Contract Details{% endblock %} {# Specific title #}

{% block content %} {# Start of the main content block #}

  {# Header Row with Title and Back Button #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Contract Details (ID: {{ contract.id }})</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
        Â« Back to Dashboard
    </a>
  </div>

  {# Action Buttons Row Removed from View Page - Moved to Dashboard #}
  <hr> {# Add a separator after the header #}


  {# --- Engagement Details Card --- #}
   <div class="card mb-4 shadow-sm">
       <div class="card-header fw-bold">Engagement Details</div>
       <div class="card-body">
           <dl class="row mb-0">
               <dt class="col-sm-4 col-lg-3">Engagement Date:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.engagement_date.strftime('%Y-%m-%d') if contract.engagement_date else 'Not Set' }}</dd>

               <dt class="col-sm-4 col-lg-3">Time:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.start_time.strftime('%I:%M %p') if contract.start_time else 'N/A' }} to {{ contract.end_time.strftime('%I:%M %p') if contract.end_time else 'N/A' }}</dd>

               <dt class="col-sm-4 col-lg-3">Actual Paid Hours:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.actual_hours_engagement or 'Not Set' }}</dd>

               <dt class="col-sm-4 col-lg-3">Venue:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.venue_name or 'Not Set' }}</dd>

               <dt class="col-sm-4 col-lg-3">Location:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.location_borough or 'Not Set' }}</dd>

               <dt class="col-sm-4 col-lg-3">Type:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.engagement_type or 'Not Set' }}</dd>

               {# --- ADDED Scale Display --- #}
               <dt class="col-sm-4 col-lg-3">Applicable Scale:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.applicable_local or 'N/A' }} / {{ contract.applicable_scale or 'N/A' }}</dd>
               {# --- END ADDED Scale Display --- #}

               <dt class="col-sm-4 col-lg-3">Pre-Heat Hours:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.pre_heat_hours if contract.pre_heat_hours is not none else 'N/A' }}</dd>
           </dl>
       </div>
   </div>

    {# --- Leader/Employer Details Card --- #}
    <div class="card mb-4 shadow-sm">
       <div class="card-header fw-bold">Leader/Employer Details</div>
       <div class="card-body">
            <dl class="row mb-0">
               <dt class="col-sm-4 col-lg-3">Name:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.leader_name or 'Not Set' }}</dd>
               <dt class="col-sm-4 col-lg-3">AFM Card #:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.leader_card_no or 'N/A' }}</dd>
               <dt class="col-sm-4 col-lg-3">Address:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.leader_address or 'Not Set' }}</dd>
               <dt class="col-sm-4 col-lg-3">Phone:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.leader_phone or 'Not Set' }}</dd>
               <dt class="col-sm-4 col-lg-3">Band Name:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.band_name or 'N/A' }}</dd>
                <dt class="col-sm-4 col-lg-3">Leader SSN/EIN:</dt>
                <dd class="col-sm-8 col-lg-9">{{ contract.leader_ssn_ein or 'N/A' }} <span class="pii-warning">(Sensitive Data)</span></dd>
                <dt class="col-sm-4 col-lg-3">Incorporated:</dt>
                <dd class="col-sm-8 col-lg-9">{{ 'Yes' if contract.leader_is_incorporated else 'No' }}</dd>
           </dl>
       </div>
   </div>

   {# --- Side Musician Details Card --- #}
   <div class="card mb-4 shadow-sm">
       <div class="card-header fw-bold">Side Musician Details</div>
       {% if musicians %} {# Check if the musicians list exists and is not empty #}
           <div class="table-responsive">
               <table class="table table-striped table-hover table-sm mb-0">
                   <thead class="table-light">
                       <tr>
                           <th>#</th>
                           <th>Name</th>
                           <th>Instrument(s)</th>
                           <th>AFM Card #</th>
                           <th>Tax ID / ID # <span class="pii-warning">(PII)</span></th> {# Updated Header #}
                           <th>Doubling?</th>
                           <th>Cartage?</th>
                       </tr>
                   </thead>
                   <tbody>
                       {% for musician in musicians %} {# Loop through the musicians passed from Flask #}
                       <tr>
                           <td>{{ loop.index }}</td> {# Display musician number (1, 2, 3...) #}
                           <td>{{ musician.name or 'N/A' }}</td>
                           <td>{{ musician.instrument or 'N/A' }}</td>
                           <td>{{ musician.card_no or 'N/A' }}</td>
                           <td>
                               {# Generic masking showing last 4 chars #}
                               {% if musician.tax_id and musician.tax_id|length >= 4 %}
                                   ...{{ musician.tax_id[-4:] }}
                               {% elif musician.tax_id %}
                                   *** {# Mask shorter IDs completely #}
                               {% else %}
                                   N/A
                               {% endif %}
                           </td>
                           <td>{% if musician.is_doubling %}Yes{% else %}No{% endif %}</td>
                           <td>{% if musician.has_cartage %}Yes{% else %}No{% endif %}</td>
                       </tr>
                       {% endfor %} {# End of loop #}
                   </tbody>
               </table>
           </div>
       {% else %} {# If no musicians were found/passed #}
           <div class="card-body">
               <p class="card-text text-muted mb-0">No side musicians listed for this contract.</p>
           </div>
       {% endif %} {# End of check for musicians #}
   </div>
   {# --- End Side Musician Details Card --- #}


    {# --- Payment Summary Card --- #}
    <div class="card mb-4 shadow-sm">
       <div class="card-header fw-bold">Payment Summary {% if contract.status == 'draft' %}(Estimates - Calculated on Save){% elif contract.status == 'completed' %}(Calculated){% endif %}</div> {# Updated title #}
       <div class="card-body">
            <dl class="row mb-0">
               <dt class="col-sm-4 col-lg-3">Total Musicians:</dt>
               <dd class="col-sm-8 col-lg-9">{{ contract.num_musicians or 'N/A' }}</dd>

               <dt class="col-sm-4 col-lg-3">Rehearsal:</dt>
               <dd class="col-sm-8 col-lg-9">{{ 'Yes' if contract.has_rehearsal else 'No' }}{% if contract.has_rehearsal %} ({{ contract.actual_hours_rehearsal or 'N/A' }} hrs){% endif %}</dd> {# Corrected syntax #}

               <dt class="col-sm-4 col-lg-3">Recording:</dt>
               <dd class="col-sm-8 col-lg-9">{{ 'Yes' if contract.is_recorded else 'No' }} {% if contract.is_recorded %}<strong class="text-danger">Warning: Requires specific agreement!</strong>{% endif %}</dd>
               <dt class="col-sm-12"><hr class="my-2"></dt> {# Separator #}
                <dt class="col-sm-4 col-lg-3">Total Gross Comp:</dt>
                <dd class="col-sm-8 col-lg-9">${{ "%.2f"|format(contract.total_gross_comp or 0.00) }} {% if contract.status == 'draft' %}<span class="text-muted">(Estimate)</span>{% endif %}</dd>
                <dt class="col-sm-4 col-lg-3">Total Work Dues (Rate Varies):</dt> {# Updated Label #}
                <dd class="col-sm-8 col-lg-9">${{ "%.2f"|format(contract.total_work_dues or 0.00) }} {% if contract.status == 'draft' %}<span class="text-muted">(Estimate)</span>{% endif %}</dd>
                <dt class="col-sm-4 col-lg-3">Total Pension (AFM-EPF):</dt>
                <dd class="col-sm-8 col-lg-9">${{ "%.2f"|format(contract.total_pension or 0.00) }} {% if contract.status == 'draft' %}<span class="text-muted">(Estimate)</span>{% endif %}</dd>
                <dt class="col-sm-4 col-lg-3">Total Health (HBP):</dt>
                <dd class="col-sm-8 col-lg-9">${{ "%.2f"|format(contract.total_health or 0.00) }} {% if contract.status == 'draft' %}<span class="text-muted">(Estimate)</span>{% endif %}</dd>
            </dl>
            <p class="text-muted mt-3 mb-0">Note: Calculations based on {{ contract.applicable_local }}/{{ contract.applicable_scale }} scale. Final amounts depend on actual scale, overtime, etc.</p> {# Dynamic Note #}
       </div>
   </div>

   {# PDF Generation Button Commented Out using raw tags #}
   <!--
   <div class="mt-4 d-flex justify-content-end">
       {% raw %} {# PREVENT JINJA FROM PROCESSING url_for WHEN COMMENTED OUT #}
       <a href="{{ url_for('download_contract_pdf', contract_id=contract.id) }}" class="btn btn-info" target="_blank" title="Download as PDF">
           <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer-fill me-1" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/></svg>
           Generate PDF
       </a>
       {% endraw %} {# END RAW BLOCK #}
   </div>
   -->

{% endblock %} {# End of content block #}
